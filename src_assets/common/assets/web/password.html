<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sunshine</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link href="@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script type="module" src="bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body id="app">
  <Sunshine-Header></Sunshine-Header>
  <div class="container">
    <h1 class="my-4">Password Change</h1>
    <form @submit.prevent="save">
      <div class="card d-flex p-4 flex-row">
        <div class="col-md-6 px-4">
          <h4>Current Credentials</h4>
          <div class="mb-3">
            <label for="currentUsername" class="form-label">Username</label>
            <input required type="text" class="form-control" id="currentUsername"
              v-model="passwordData.currentUsername" />
            <div class="form-text">&nbsp;</div>
          </div>
          <div class="mb-3">
            <label for="currentPassword" class="form-label">Password</label>
            <input autocomplete="current-password" type="password" class="form-control" id="currentPassword"
              v-model="passwordData.currentPassword" />
          </div>
        </div>
        <div class="col-md-6 px-4">
          <h4>New Credentials</h4>
          <div class="mb-3">
            <label for="newUsername" class="form-label">New Username</label>
            <input type="text" class="form-control" id="newUsername" v-model="passwordData.newUsername" />
            <div class="form-text">
              If not specified, the username will not change
            </div>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label">Password</label>
            <input autocomplete="new-password" required type="password" class="form-control" id="newPassword"
              v-model="passwordData.newPassword" />
          </div>
          <div class="mb-3">
            <label for="confirmNewPassword" class="form-label">Confirm Password</label>
            <input autocomplete="new-password" required type="password" class="form-control" id="confirmNewPassword"
              v-model="passwordData.confirmNewPassword" />
          </div>
        </div>
      </div>
      <div class="alert alert-danger" v-if="error"><b>Error: </b>{{error}}</div>
      <div class="alert alert-success" v-if="success">
        <b>Success! </b>This page will reload soon, your browser will ask you for
        the new credentials
      </div>
      <div class="mb-3 buttons">
        <button class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</body>
<script type="module">
  import { createApp } from 'vue'
  import SunshineHeader from './SunshineHeader.vue'

  const app = createApp({
    components: {
      SunshineHeader
    },
    data() {
      return {
        error: null,
        success: false,
        passwordData: {
          currentUsername: "",
          currentPassword: "",
          newUsername: "",
          newPassword: "",
          confirmNewPassword: "",
        },
      };
    },
    methods: {
      save() {
        this.error = null;
        fetch("/api/password", {
          method: "POST",
          body: JSON.stringify(this.passwordData),
        }).then((r) => {
          if (r.status == 200) {
            r.json().then((rj) => {
              if (rj.status.toString() === "true") {
                this.success = true;
                setTimeout(() => {
                  document.location.reload();
                }, 5000);
              } else {
                this.error = rj.error;
              }
            });
          } else {
            this.error = "Internal Server Error";
          }
        });
      },
    },
  });

  app.mount("#app");
</script>

<style>
  .config-page {
    padding: 1em;
    border: 1px solid #dee2e6;
    border-top: none;
  }

  .buttons {
    padding: 1em 0;
  }
</style>