<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
  <title>API Token Management &mdash; Sunshine</title>
  <%- header %>
  <style>
    :root {
      --font-base: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --color-bg: #ffffff;
      --color-bg-alt: #f9fafb;
      --color-border: #e5e7eb;
      --color-border-dark: #d1d5db;
      --color-text: #111827;
      --color-accent: #2563eb; /* blue-600 */
      --color-accent-hover: #1e4fcb; /* darker accent */
      --color-danger: #dc2626; /* red-600 */
      --color-danger-hover: #b91c1c; /* darker red */
      --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
      --radius-lg: 1rem;
      --radius-md: 0.5rem;
      --radius-sm: 0.375rem;
      --spacing-1: 0.25rem;
      --spacing-2: 0.5rem;
      --spacing-3: 0.75rem;
      --spacing-4: 1rem;
      --spacing-5: 1.5rem;
      --spacing-6: 2rem;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: #181a20;
        --color-bg-alt: #232634;
        --color-border: #353945;
        --color-border-dark: #444857;
        --color-text: #f1f1f1;
        --color-accent: #3b82f6;
        --color-accent-hover: #2563eb;
        --color-danger: #f87171;
        --color-danger-hover: #dc2626;
        --shadow-md: 0 4px 20px rgba(0,0,0,0.32);
      }
      .token-table,
      .token-table th,
      .token-table td {
        background: var(--color-bg) !important;
        color: var(--color-text) !important;
        border-color: var(--color-border) !important;
      }
      .token-table th {
        background: var(--color-bg-alt) !important;
      }
      select,
      input[type="text"],
      input[type="password"],
      .scopes-list select,
      .scopes-list input[type="text"],
      .token-tester select,
      .token-tester input {
        background: var(--color-bg) !important;
        color: var(--color-text) !important;
        border-color: var(--color-border-dark) !important;
      }
      select:disabled,
      input:disabled {
        background: #232634 !important;
        color: #888 !important;
      }
    }
    [data-bs-theme="dark"] {
      --color-bg: #181a20;
      --color-bg-alt: #232634;
      --color-border: #353945;
      --color-border-dark: #444857;
      --color-text: #f1f1f1;
      --color-accent: #3b82f6;
      --color-accent-hover: #2563eb;
      --color-danger: #f87171;
      --color-danger-hover: #dc2626;
      --shadow-md: 0 4px 20px rgba(0,0,0,0.32);
    }
    [data-bs-theme="dark"] .token-table,
    [data-bs-theme="dark"] .token-table th,
    [data-bs-theme="dark"] .token-table td {
      background: var(--color-bg) !important;
      color: var(--color-text) !important;
      border-color: var(--color-border) !important;
    }
    [data-bs-theme="dark"] .token-table th {
      background: var(--color-bg-alt) !important;
    }
    [data-bs-theme="dark"] select,
    [data-bs-theme="dark"] input[type="text"],
    [data-bs-theme="dark"] input[type="password"],
    [data-bs-theme="dark"] .scopes-list select,
    [data-bs-theme="dark"] .scopes-list input[type="text"],
    [data-bs-theme="dark"] .token-tester select,
    [data-bs-theme="dark"] .token-tester input {
      background: var(--color-bg) !important;
      color: var(--color-text) !important;
      border-color: var(--color-border-dark) !important;
    }
    [data-bs-theme="dark"] select:disabled,
    [data-bs-theme="dark"] input:disabled {
      background: #232634 !important;
      color: #888 !important;
    }
    html, body {
      padding: 0;
      margin: 0;
      font-family: var(--font-base);
      background: var(--color-bg-alt);
      color: var(--color-text);
      line-height: 1.6;
    }

    /* Main Container */
    .token-page {
      max-width: 900px;
      margin: var(--spacing-5) auto;
      padding: var(--spacing-4);
    }

    
    .token-page h1 {
      font-size: 2.25rem;
      margin-bottom: var(--spacing-5);
      font-weight: 700;
      text-align: center;
    }

    .token-page h2 {
      font-size: 1.5rem;
      margin-top: var(--spacing-6);
      margin-bottom: var(--spacing-4);
      font-weight: 600;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: var(--spacing-2);
    }

    /* Card styling for sections */
    .card {
      background: var(--color-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-5);
      margin-bottom: var(--spacing-5);
    }

    /* Form wrapper */
    .token-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-4);
    }

    /* Scope list */
    .scopes-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-4);
    }

    .scope-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: var(--spacing-3);
      align-items: center;
    }

    .scopes-list select,
    .scopes-list input[type=text] {
      border: 1px solid var(--color-border-dark);
      border-radius: var(--radius-sm);
      padding: var(--spacing-2) var(--spacing-3);
      font-size: 0.95rem;
      background: var(--color-bg);
      width: 100%;
    }

    .scopes-list button,
    .token-form button,
    .token-tester button,
    .danger-btn {
      background: var(--color-accent);
      color: #ffffff;
      border: none;
      border-radius: var(--radius-sm);
      padding: var(--spacing-2) var(--spacing-4);
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 0.95rem;
    }

    .scopes-list button:hover,
    .token-form button:hover,
    .token-tester button:hover,
    .danger-btn:hover {
      background: var(--color-accent-hover);
    }

    .scope-row button,
    .danger-btn {
      background-color: var(--color-danger);
    }
    .scope-row button:hover,
    .danger-btn:hover {
      background-color: var(--color-danger-hover);
    }
    
    .token-form button[type=submit] {
        align-self: flex-end;
        padding: var(--spacing-2) var(--spacing-5);
        font-weight: 600;
    }

    /* Token result box */
    .token-box {
      background: var(--color-bg-alt);
      border: 1px solid var(--color-border);
      padding: var(--spacing-4);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-4);
      font-size: 1rem;
      word-break: break-all;
    }

    .token-warning {
      color: var(--color-danger);
      font-weight: 600;
      display: block;
      margin-bottom: var(--spacing-2);
    }
    
    /* Token Table */
    .token-table-wrapper {
        overflow-x: auto;
        width: 100%;
        min-width: 0;
    }

    .token-table {
      width: 100%;
      min-width: 700px;
      border-collapse: collapse;
      margin-top: var(--spacing-4);
      background: var(--color-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      font-size: 0.9rem;
      border: 1px solid var(--color-border);
      table-layout: auto;
    }

    .token-table th,
    .token-table td {
      border-bottom: 1px solid var(--color-border);
      padding: var(--spacing-3) var(--spacing-4);
      text-align: left;
      vertical-align: middle;
    }

    .token-table th {
      background: var(--color-bg-alt);
      font-weight: 600;
    }
    
    .token-table tbody tr:last-child th,
    .token-table tbody tr:last-child td {
        border-bottom: none;
    }

    .token-table td button {
      background: var(--color-danger);
      padding: var(--spacing-1) var(--spacing-3);
      font-size: 0.85rem;
    }

    .token-table td button:hover {
      background: var(--color-danger-hover);
    }

    /* Token tester */
    .token-tester form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-4);
    }

    .token-tester label {
      display: block;
      margin-bottom: var(--spacing-2);
      font-weight: 500;
    }

    .token-tester select,
    .token-tester input {
      border: 1px solid var(--color-border-dark);
      border-radius: var(--radius-sm);
      padding: var(--spacing-2) var(--spacing-3);
      font-size: 0.95rem;
      background: var(--color-bg);
      width: 100%;
    }

    .token-tester button[type=submit] {
      align-self: flex-start;
      padding: var(--spacing-2) var(--spacing-5);
    }

    .token-tester pre {
        background: var(--color-bg-alt);
        border: 1px solid var(--color-border);
        padding: var(--spacing-3);
        border-radius: var(--radius-md);
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .alert-danger {
        color: var(--color-danger);
        background-color: #fef2f2;
        border: 1px solid var(--color-danger);
        border-radius: var(--radius-md);
        padding: var(--spacing-3);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .scope-row {
            grid-template-columns: 1fr;
        }
        .token-form button[type=submit] {
            align-self: stretch;
        }
    }

    @media (max-width: 600px) {
      .token-page {
        padding: var(--spacing-2);
        margin: var(--spacing-2) auto;
      }
      .card {
        padding: var(--spacing-4);
      }
      .token-page h1 {
        font-size: 1.75rem;
      }
      .token-page h2 {
          font-size: 1.25rem;
      }
    }
  </style>
</head>
<body id="app" v-cloak>
  <Navbar></Navbar>
  <div class="token-page">
    <h1>API Token Management</h1>

    <div id="generate-token-section" class="card">
        <h2>Generate New Token</h2>
        <form @submit.prevent="generateToken" class="token-form">
          <div class="scopes-list">
            <div v-for="(scope, idx) in scopes" :key="idx" class="scope-row">
              <select v-model="scope.path" @change="scope.methods = []" required>
                <option value="" disabled>Select API Path</option>
                <option v-for="route in apiRoutes" :key="route.path" :value="route.path">{{ route.path }}</option>
              </select>
              <select v-model="scope.methods" multiple size="3" :disabled="!scope.path" required>
                <option v-for="m in getMethodsForPath(scope.path)" :key="m" :value="m">{{ m }}</option>
              </select>
              <button type="button" @click="removeScope(idx)">Remove</button>
            </div>
          </div>
          <button type="button" @click="addScope">Add Scope</button>
          <button type="submit">Generate Token</button>
        </form>
        <div v-if="tokenResult" class="token-box">
          <span class="token-warning">Success! Copy this token now as you will not see it again:</span>
          <code>{{ tokenResult }}</code>
        </div>
    </div>
    
    <div id="active-tokens-section" class="card">
        <h2>Active Tokens</h2>
        <div class="token-table-wrapper">
            <table class="token-table">
              <thead>
                <tr><th>Hash</th><th>Username</th><th>Created</th><th>Scopes</th><th></th></tr>
              </thead>
              <tbody>
                <tr v-if="!tokens.length"><td colspan="5" style="text-align: center;">No active tokens.</td></tr>
                <tr v-for="t in tokens" :key="t.hash">
                  <td>{{ t.hash.substring(0, 8) }}...</td>
                  <td>{{ t.username }}</td>
                  <td>{{ formatDate(t.created_at) }}</td>
                  <td>
                    <span v-for="(s, i) in t.scopes" :key="i">
                      {{ s.path }}: [{{ s.methods.join(', ') }}]<br />
                    </span>
                  </td>
                  <td><button class="danger-btn" @click="revokeToken(t.hash)">Revoke</button></td>
                </tr>
              </tbody>
            </table>
        </div>
    </div>
    
    <div id="test-token-section" class="card">
        <h2>Test API Token</h2>
        <div class="token-tester">
          <form @submit.prevent="testToken">
            <div>
              <label for="testPath">API Path (GET requests only)</label>
              <select id="testPath" v-model="testPath" required>
                <option value="" disabled>Select API Path to Test</option>
                <option v-for="route in apiRoutes.filter(r => r.methods.includes('GET'))" :key="route.path" :value="route.path">{{ route.path }}</option>
              </select>
            </div>
            <div>
              <label for="testTokenInput">Token</label>
              <input id="testTokenInput" v-model="testTokenInput" type="password" autocomplete="off" placeholder="Paste API token here" required />
            </div>
            <button type="submit">Test Token</button>
          </form>
          <div v-if="testResult || testError" class="mt-4">
            <b>Result:</b>
            <div v-if="testError" class="alert alert-danger mt-2">{{ testError }}</div>
            <pre v-if="testResult" class="mt-2">{{ testResult }}</pre>
          </div>
        </div>
    </div>
  </div>

  <script type="module">
    import { createApp } from 'vue';
    import { initApp } from './init';
    import Navbar from './Navbar.vue';

    // List of API routes and methods
    const apiRoutes = [
      { path: "/api/pin", methods: ["POST"] },
      { path: "/api/apps", methods: ["GET", "POST"] },
      { path: "/api/logs", methods: ["GET"] },
      { path: "/api/config", methods: ["GET", "POST"] },
      { path: "/api/configLocale", methods: ["GET"] },
      { path: "/api/restart", methods: ["POST"] },
      { path: "/api/reset-display-device-persistence", methods: ["POST"] },
      { path: "/api/password", methods: ["POST"] },
      { path: "/api/apps/([0-9]+)", methods: ["DELETE"] },
      { path: "/api/clients/unpair-all", methods: ["POST"] },
      { path: "/api/clients/list", methods: ["GET"] },
      { path: "/api/clients/unpair", methods: ["POST"] },
      { path: "/api/apps/close", methods: ["POST"] },
      { path: "/api/covers/upload", methods: ["POST"] },
      { path: "/api/token", methods: ["POST"] },
      { path: "/api/tokens", methods: ["GET"] },
      { path: "/api/token/([a-fA-F0-9]+)", methods: ["DELETE"] }
    ];

    const app = createApp({
      components: { Navbar },
      data() {
        return {
          scopes: [{ path: '', methods: [] }],
          tokenResult: '',
          tokens: [],
          apiRoutes,
          // Token tester state
          testPath: '',
          testTokenInput: '',
          testResult: '',
          testError: ''
        };
      },
      methods: {
        addScope() {
          this.scopes.push({ path: '', methods: [] });
        },
        removeScope(idx) {
          if (this.scopes.length > 1) {
            this.scopes.splice(idx, 1);
          }
        },
        getMethodsForPath(path) {
          const found = this.apiRoutes.find(r => r.path === path);
          return found ? found.methods : ["GET", "POST", "DELETE", "PATCH", "PUT"];
        },
        async generateToken() {
          const filtered = this.scopes.filter(s => s.path && s.methods.length);
          if (!filtered.length) {
            alert('Please specify at least one path and corresponding method(s).');
            return;
          }
          try {
            const res = await fetch('/api/token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ scopes: filtered })
            });
            const data = await res.json();
            if (res.ok && data.token) {
              this.tokenResult = data.token;
              this.loadTokens();
            } else {
              this.tokenResult = `Error: ${data.error || 'Failed to generate token.'}`;
            }
          } catch(e) {
              this.tokenResult = `Request failed: ${e.message}`;
          }
        },
        async loadTokens() {
          try {
            const res = await fetch('/api/tokens');
            if(res.ok) {
                this.tokens = await res.json();
            } else {
                console.error("Failed to load tokens");
                this.tokens = [];
            }
          } catch(e) {
              console.error("Error fetching tokens:", e);
              this.tokens = [];
          }
        },
        async revokeToken(hash) {
          if (!confirm('Are you sure you want to revoke this token? This action cannot be undone.')) return;
          try {
            const res = await fetch(`/api/token/${hash}`, { method: 'DELETE' });
            if(res.ok) {
                this.loadTokens();
            } else {
                alert("Failed to revoke token.");
            }
          } catch(e) {
              alert(`Error revoking token: ${e.message}`);
          }
        },
        formatDate(ts) {
          return new Date(ts * 1000).toLocaleString();
        },
        async testToken() {
          this.testResult = '';
          this.testError = '';
          if (!this.testPath || !this.testTokenInput) {
            this.testError = 'Please select an API path and provide a token.';
            return;
          }
          try {
            const res = await fetch(this.testPath, {
              method: 'GET',
              headers: {
                'Authorization': 'Bearer ' + this.testTokenInput
              },
              credentials: 'omit'
            });

            const contentType = res.headers.get("content-type");
            let bodyText = await res.text();
            let isJson = contentType && contentType.indexOf("application/json") !== -1 && bodyText;
            if (isJson) {
              try {
                this.testResult = JSON.stringify(JSON.parse(bodyText), null, 2);
              } catch {
                this.testResult = bodyText;
              }
            } else {
              this.testResult = bodyText;
            }

            if (!res.ok) {
              this.testError = `HTTP ${res.status}: ${res.statusText}`;
            } else {
              this.testError = '';
            }

          } catch (e) {
            this.testError = `Request failed: ${e.message}`;
          }
        }
      },
      mounted() {
        this.loadTokens();
      }
    });
    initApp(app);
  </script>
</body>
</html>