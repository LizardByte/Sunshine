---
name: CI

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ucrt64
          update: true
          install: >-
            wget
            git
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-cppwinrt
            mingw-w64-ucrt-x86_64-curl-winssl
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-graphviz
            mingw-w64-ucrt-x86_64-MinHook
            mingw-w64-ucrt-x86_64-miniupnpc
            mingw-w64-ucrt-x86_64-nlohmann-json
            mingw-w64-ucrt-x86_64-nodejs
            mingw-w64-ucrt-x86_64-nsis
            mingw-w64-ucrt-x86_64-onevpl
            mingw-w64-ucrt-x86_64-openssl
            mingw-w64-ucrt-x86_64-opus
            mingw-w64-ucrt-x86_64-toolchain
            mingw-w64-ucrt-x86_64-boost
            mingw-w64-ucrt-x86_64-x265

      - name: Install Doxygen
        env:
          DOXYGEN_VERSION: "1.11.0"
        shell: pwsh
        run: |
          $doxy_ver = $env:DOXYGEN_VERSION
          $_doxy_ver = $doxy_ver.Replace(".", "_")
          Invoke-WebRequest -Uri "https://github.com/doxygen/doxygen/releases/download/Release_${_doxy_ver}/doxygen-${doxy_ver}-setup.exe" -OutFile "doxygen-setup.exe"
          Start-Process -FilePath .\doxygen-setup.exe -ArgumentList '/VERYSILENT' -Wait -NoNewWindow
          Remove-Item -Path doxygen-setup.exe

      - name: Build Sunshine
        env:
          BUILD_VERSION: ${{ github.ref_name }}
          BRANCH: ${{ github.ref_name == 'master' && 'master' || github.head_ref }}
          COMMIT: ${{ github.sha }}
        run: |
          mkdir -p build
          cd build

          cmake \
            -G "MinGW Makefiles" \
            -B . \
            -S .. \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DSUNSHINE_ASSETS_DIR=assets \
            -DBUILD_TESTS=ON \
            -DSUNSHINE_PUBLISHER_NAME='${{ github.repository_owner }}' \
            -DSUNSHINE_PUBLISHER_WEBSITE='https://github.com/${{ github.repository }}' \
            -DSUNSHINE_PUBLISHER_ISSUE_URL='https://github.com/${{ github.repository }}/issues'

          mingw32-make -j$(nproc)

          # Verify build succeeded
          if [ -f sunshine.exe ]; then
            echo "? sunshine.exe built successfully"
            ls -la sunshine.exe
          else
            echo "? sunshine.exe not found"
            exit 1
          fi

      - name: Run Tests
        working-directory: build/tests
        run: |
          if [ -f test_sunshine.exe ]; then
            ./test_sunshine.exe --gtest_color=yes || echo "Tests failed but continuing..."
          else
            echo "?? test_sunshine.exe not found, skipping tests"
          fi
